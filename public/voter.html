<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Voter Panel - VoteChain</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; background: #f3f3f3; padding: 20px; }
    h1 { text-align: center; }
    .voter-info { text-align: center; margin-top: 10px; font-size: 18px; color: #0077cc; font-weight: bold; }
    .container { max-width: 600px; background: white; padding: 25px; margin: 20px auto; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { font-weight: bold; }
    select, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; }
    button { background: #4CAF50; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #45a049; }
  </style>
</head>
<body>
  <h1>üó≥Ô∏è Voter Panel</h1>
  <div class="voter-info" id="voterInfo">Loading your voter ID...</div>

  <div class="container">
    <form id="voteForm">
      <label for="electionSelect">Select Election</label>
      <select id="electionSelect" required>
        <option value="">Loading elections...</option>
      </select>

      <div id="candidatesContainer">
  <p><strong>Select Candidate:</strong></p>
  <!-- Radio buttons will load here -->
</div>


      <button type="submit">Vote</button>
    </form>
    <hr>
<h2>Report a Problem / Raise Dispute</h2>
<form id="disputeForm">
  <label for="disputeElection">Election</label>
  <select id="disputeElection" required></select>

  <label for="issueText">Issue (short description)</label>
  <textarea id="issueText" rows="3" style="width:100%" required></textarea>

  <button type="submit">Submit Dispute</button>
</form>

<h3>Your Disputes</h3>
<div id="myDisputes">Loading your disputes...</div>

  </div>

  <script>
/* ----------------- Unified client script for voting + disputes ----------------- */

const voterId = localStorage.getItem('voterId');
if (!voterId) {
  alert('You must login first.');
  window.location.href = '/login.html';
}

// page elements
document.getElementById('voterInfo').innerText = `Welcome, your Voter ID is: ${voterId}`;
const electionSelect = document.getElementById('electionSelect');
const candidateSelect = document.getElementById('candidateSelect');
const voterForm = document.getElementById('voteForm');

const disputeElection = document.getElementById('disputeElection');
const issueText = document.getElementById('issueText');
const disputeForm = document.getElementById('disputeForm');
const myDisputes = document.getElementById('myDisputes');

let electionsData = []; // will be filled from server

// 1) Load elections from server
fetch("/elections")
  .then(res => res.json())
  .then(data => {
    // normalize entries (support id or _id)
    electionsData = data.map(e => ({
      id: e.id || e._id,
      title: e.title,
      candidates: e.candidates || []
    }));

    // if no elections
    if (!electionsData.length) {
      electionSelect.innerHTML = '<option value="">No elections available</option>';
      candidateSelect.innerHTML = '<option value="">No candidates</option>';
      disputeElection.innerHTML = '<option value="">No elections</option>';
      // still load disputes for this voter
      loadMyDisputes();
      return;
    }

    // populate voting select
    electionSelect.innerHTML = electionsData.map(e => `<option value="${e.id}">${e.title}</option>`).join("");
    // populate candidates for the initially selected election
    updateCandidates();

    // populate dispute election select (only AFTER electionsData is ready)
    populateDisputeElection();

    // load this voter's disputes (after dispute select exists)
    loadMyDisputes();
  })
  .catch(err => {
    console.error('Failed to load elections:', err);
    electionSelect.innerHTML = '<option value="">Error loading elections</option>';
    disputeElection.innerHTML = '<option value="">Error</option>';
  });

/* update candidate dropdown when election changes */
electionSelect.addEventListener("change", updateCandidates);
function updateCandidates() {
  const electionId = electionSelect.value;
  const election = electionsData.find(e => e.id === electionId);
  const container = document.getElementById("candidatesContainer");

  if (election && election.candidates.length) {
    container.innerHTML = `
      <p><strong>Select Candidate:</strong></p>
      ${election.candidates.map(c => `
        <label>
          <input type="radio" name="candidate" value="${c}" required>
          ${c}
        </label><br>
      `).join("")}
    `;
  } else {
    container.innerHTML = "<p>No candidates available.</p>";
  }
}


/* populate dispute election dropdown ‚Äî call only AFTER electionsData is set */
function populateDisputeElection() {
  if (!electionsData.length) {
    disputeElection.innerHTML = '<option value="">No elections</option>';
    return;
  }
  disputeElection.innerHTML = electionsData.map(e => `<option value="${e.id}">${e.title}</option>`).join('');
}

/* voting submit */
voterForm.addEventListener('submit', function(e) {
  e.preventDefault();
  const electionId = electionSelect.value;
  const candidate = document.querySelector('input[name="candidate"]:checked')?.value;

  if (!electionId || !candidate) { alert("Please select election and candidate"); return; }

  fetch('/cast-vote', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ voterId, electionId, candidate })
  })
  .then(res => res.text())
  .then(html => {
    document.open();
    document.write(html);
    document.close();
  })
  .catch(err => { console.error('Vote failed', err); alert('Vote failed'); });
});

/* ----------------- Dispute handling ----------------- */

/* submit dispute */
disputeForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const electionId = disputeElection.value;
  const issue = issueText.value.trim();
  if (!electionId || !issue) return alert('Select election and write issue.');

  try {
    const res = await fetch('/raise-dispute', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ voterId, electionId, issue })
    });
    const j = await res.json();
    if (j.success) {
      alert('Dispute submitted.');
      issueText.value = '';
      loadMyDisputes();
    } else {
      alert(j.message || 'Error submitting dispute');
    }
  } catch (err) {
    console.error('Error raising dispute', err);
    alert('Error raising dispute');
  }
});

/* load disputes for this voter */
async function loadMyDisputes() {
  try {
    const res = await fetch(`/my-disputes/${encodeURIComponent(voterId)}`);
    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) {
      myDisputes.innerHTML = '<p>No disputes found.</p>';
      return;
    }
    myDisputes.innerHTML = data.map(d => `
      <div class="dispute-card">
        <strong>${d.issue}</strong><br>
        Election: ${d.electionId}<br>
        Status: <em>${d.status}</em><br>
        Raised: ${new Date(d.createdAt).toLocaleString()}<br>
        ${d.resolution ? `<div><strong>Resolution:</strong> ${d.resolution}</div>` : ''}
      </div>
    `).join('');
  } catch (err) {
    console.error('Failed to load disputes', err);
    myDisputes.innerHTML = '<p>Error loading disputes</p>';
  }
}
</script>


</body>
</html>
